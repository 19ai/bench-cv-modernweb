<canvas id="canvasWebgl"></canvas>
<canvas id="canvas2d"></canvas>

<!-- vertex shader -->
<script id="2d-vertex-shader" type="x-shader/x-vertex">
	attribute vec2 a_position;
	attribute vec2 a_texCoord;

	varying vec2 v_texCoord;

	void main() {
		gl_Position = vec4(a_position, 0, 1);
		v_texCoord = a_texCoord;
	}
</script>
<!-- fragment shader -->
<script id="2d-fragment-shader" type="x-shader/x-fragment">
	precision mediump float;
	uniform sampler2D u_image;
	varying vec2 v_texCoord;

	void main() {
		vec4 texel = texture2D(u_image, v_texCoord);
		
		gl_FragColor = texel.bgra;
	}
</script>
<body>
	
	<script src="https://webglfundamentals.org/webgl/resources/webgl-utils.js"></script>
	<script src="https://webglfundamentals.org/webgl/resources/webgl-lessons-helper.js"></script>
<script>
'use strict';

var CANVAS_WIDTH = 640
var CANVAS_HEIGHT = 480

//////////////////////////////////////////////////////////////////////////////
//		build videoElement
//////////////////////////////////////////////////////////////////////////////
var videoElement = document.createElement('video')
// document.body.appendChild(videoElement)
videoElement.autoplay = true

// https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia
var userMediaContraints = {
        // video: true,
        video : {
                width: CANVAS_WIDTH,
                height:CANVAS_HEIGHT
        }
}
navigator.mediaDevices.getUserMedia(userMediaContraints).then(function(stream){
        videoElement.src = window.URL.createObjectURL(stream);
}).catch(function(error){
	console.assert(false, 'getUserMedia failed due to')
	console.dir(error)
})
//////////////////////////////////////////////////////////////////////////////
//		Code Separator
//////////////////////////////////////////////////////////////////////////////

var canvas2d = document.getElementById('canvas2d');
canvas2d.width = userMediaContraints.video.width
canvas2d.height = userMediaContraints.video.height
var context2d = canvas2d.getContext('2d');

//////////////////////////////////////////////////////////////////////////////
//		build canvas
//////////////////////////////////////////////////////////////////////////////

var canvasWebgl = document.getElementById('canvasWebgl');
canvasWebgl.width = userMediaContraints.video.width
canvasWebgl.height = userMediaContraints.video.height
var gl = canvasWebgl.getContext('webgl');


webglUtils.resizeCanvasToDisplaySize(gl.canvas);

// Tell WebGL how to convert from clip space to pixels
gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

// Clear the canvas
gl.clearColor(0, 0, 0, 0);
gl.clear(gl.COLOR_BUFFER_BIT);

// setup GLSL program
var program = webglUtils.createProgramFromScripts(gl, ['2d-vertex-shader', '2d-fragment-shader']);

//////////////////////////////////////////////////////////////////////////////
//		position
//////////////////////////////////////////////////////////////////////////////

// look up where the vertex data needs to go.
var positionLocation = gl.getAttribLocation(program, 'a_position');

// Create a buffer to put three 2d clip space points in
var positionBuffer = gl.createBuffer();

// Bind it to ARRAY_BUFFER (think of it as ARRAY_BUFFER = positionBuffer)
gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
// Set a rectangle the same size as the image.
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
	-1, +1,
	+1, +1,
	-1, -1,
	-1, -1,
	+1, +1,
	+1, -1,
]), gl.STATIC_DRAW);

// provide texture coordinates for the rectangle.
var texcoordBuffer = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
	0.0,  0.0,
	1.0,  0.0,
	0.0,  1.0,
	0.0,  1.0,
	1.0,  0.0,
	1.0,  1.0,
]), gl.STATIC_DRAW);

// Create a texture.
var texture = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, texture);

// Set the parameters so we can render any size image.
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
// gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);

// Tell it to use our program (pair of shaders)
gl.useProgram(program);

// Turn on the position attribute
gl.enableVertexAttribArray(positionLocation);

// Bind the position buffer.
gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);

// Tell the position attribute how to get data out of positionBuffer (ARRAY_BUFFER)
var size = 2;          // 2 components per iteration
var type = gl.FLOAT;   // the data is 32bit floats
var normalize = false; // don't normalize the data
var stride = 0;        // 0 = move forward size * sizeof(type) each iteration to get the next position
var offset = 0;        // start at the beginning of the buffer
gl.vertexAttribPointer(
	positionLocation, size, type, normalize, stride, offset
)

//////////////////////////////////////////////////////////////////////////////
//		texcoordLocation
//////////////////////////////////////////////////////////////////////////////
var texcoordLocation = gl.getAttribLocation(program, 'a_texCoord');

// Turn on the teccord attribute
gl.enableVertexAttribArray(texcoordLocation);

// Bind the position buffer.
gl.bindBuffer(gl.ARRAY_BUFFER, texcoordBuffer);

// Tell the position attribute how to get data out of positionBuffer (ARRAY_BUFFER)
var size = 2;          // 2 components per iteration
var type = gl.FLOAT;   // the data is 32bit floats
var normalize = false; // don't normalize the data
var stride = 0;        // 0 = move forward size * sizeof(type) each iteration to get the next position
var offset = 0;        // start at the beginning of the buffer
gl.vertexAttribPointer(
	texcoordLocation, size, type, normalize, stride, offset
)

requestAnimationFrame(function callback(){
	if( videoElement.videoWidth ){
		render(videoElement)
		
		context2d.drawImage(videoElement, 0, 0)
	}
	
	requestAnimationFrame(callback)	
})

function render(image) {
	// update texImage2D
	gl.bindTexture(gl.TEXTURE_2D, texture);
	gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);
	
	// Draw the rectangle.
	var primitiveType = gl.TRIANGLES;
	var offset = 0;
	var count = 6;
	gl.drawArrays(primitiveType, offset, count);
}


</script>
</body>
